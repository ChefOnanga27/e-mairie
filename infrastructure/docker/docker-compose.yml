version: '3.9'

services:

  # ── Base de données PostgreSQL ────────────────────────────────────────────
  base-de-donnees:
    image: postgres:15-alpine
    container_name: recouvrement-bd
    restart: unless-stopped
    environment:
      POSTGRES_DB: recouvrement_municipal
      POSTGRES_USER: admin_mairie
      POSTGRES_PASSWORD: mot_de_passe_securise
    ports:
      - "5432:5432"
    volumes:
      - donnees-postgres:/var/lib/postgresql/data
      - ./infrastructure/scripts/initialisation.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - réseau-municipal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_mairie -d recouvrement_municipal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis (Cache & Sessions) ──────────────────────────────────────────────
  cache-redis:
    image: redis:7-alpine
    container_name: recouvrement-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - donnees-redis:/data
    networks:
      - réseau-municipal
    command: redis-server --appendonly yes

  # ── Service Authentification ──────────────────────────────────────────────
  service-authentification:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-authentification
    restart: unless-stopped
    environment:
      - PORT_AUTHENTIFICATION=3001
      - BD_HOTE=base-de-donnees
      - NODE_ENV=production
    env_file: .env
    command: node services/authentification/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/sante"]
      interval: 30s
      retries: 3

  # ── Service Contribuables ─────────────────────────────────────────────────
  service-contribuables:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-contribuables
    restart: unless-stopped
    environment:
      - PORT_CONTRIBUABLES=3002
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/contribuables/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Service Recettes ──────────────────────────────────────────────────────
  service-recettes:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-recettes
    restart: unless-stopped
    environment:
      - PORT_RECETTES=3003
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/recettes/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Service Paiements ─────────────────────────────────────────────────────
  service-paiements:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-paiements
    restart: unless-stopped
    environment:
      - PORT_PAIEMENTS=3004
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/paiements/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Service Recouvrement ──────────────────────────────────────────────────
  service-recouvrement:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-recouvrement
    restart: unless-stopped
    environment:
      - PORT_RECOUVREMENT=3005
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/recouvrement/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Service Tableaux de Bord ──────────────────────────────────────────────
  service-tableaux-de-bord:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-tableaux-de-bord
    restart: unless-stopped
    environment:
      - PORT_TABLEAUX_DE_BORD=3006
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/tableaux-de-bord/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Service Notifications ─────────────────────────────────────────────────
  service-notifications:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: svc-notifications
    restart: unless-stopped
    environment:
      - PORT_NOTIFICATIONS=3007
      - BD_HOTE=base-de-donnees
    env_file: .env
    command: node services/notifications/src/application.js
    depends_on:
      base-de-donnees:
        condition: service_healthy
    networks:
      - réseau-municipal

  # ── Passerelle API ────────────────────────────────────────────────────────
  passerelle-api:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
    container_name: passerelle-api
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT_PASSERELLE=3000
      - PORT_AUTHENTIFICATION=3001
      - PORT_CONTRIBUABLES=3002
      - PORT_RECETTES=3003
      - PORT_PAIEMENTS=3004
      - PORT_RECOUVREMENT=3005
      - PORT_TABLEAUX_DE_BORD=3006
      - PORT_NOTIFICATIONS=3007
    env_file: .env
    command: node passerelle/serveur.js
    depends_on:
      - service-authentification
      - service-contribuables
      - service-recettes
      - service-paiements
      - service-recouvrement
      - service-tableaux-de-bord
      - service-notifications
    networks:
      - réseau-municipal

  # ── Nginx (Reverse Proxy + SSL) ───────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - passerelle-api
    networks:
      - réseau-municipal

volumes:
  donnees-postgres:
    driver: local
  donnees-redis:
    driver: local

networks:
  réseau-municipal:
    driver: bridge
